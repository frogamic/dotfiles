#! /usr/bin/env bash

set -Euo pipefail

PROFILE="${1:-default}"

MFA_DEVICE="$(aws iam list-mfa-devices --profile="${PROFILE}-mfa" --query='MFADevices[0].SerialNumber' --output=text)"

echo "Enter 2fa code:"
read TOKEN

SESSION_CREDENTIAL="$(aws sts get-session-token --serial-number="${MFA_DEVICE}" --profile=${PROFILE}-mfa --token-code=$TOKEN --output=json --query Credentials)"

aws configure set aws_access_key_id "$(echo $SESSION_CREDENTIAL | jq -r .AccessKeyId)" --profile=$PROFILE
aws configure set aws_secret_access_key "$(echo $SESSION_CREDENTIAL | jq -r .SecretAccessKey)" --profile=$PROFILE
aws configure set aws_session_token "$(echo $SESSION_CREDENTIAL | jq -r .SessionToken)" --profile=$PROFILE
